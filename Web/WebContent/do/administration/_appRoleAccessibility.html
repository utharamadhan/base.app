<div class="modal-content">
	<div class="modal-header">
		<button type="button" class="close" data-dismiss="modal">&times;</button>
		<h4 class="modal-title">Accessibility</h4>
	</div>
	<div class="modal-body" style="height:325px;overflow:hidden;">
		<form id="accessibilityForm">
			<input type="hidden" name="pkAppRole" th:value="${pkAppRole}"/>
			<input type="hidden" name="accessibilities" id="accessibilities" value=""/>
			<div class="form-group">
				<div class="col-sm-12">
					<div id="accessibility-tree" class="panel-body fancytree-colorize-hover fancytree-fade-expander" style="height:300px;overflow-y:scroll">
						<ul></ul>
					</div>
				</div>
			</div>
		</form>
	</div>
	<div class="modal-footer">
		<button id="appRoleAccessibility-btn-save" type="button" class="btn btn-primary" data-dismiss="modal">Save</button>
		<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
	</div>
</div>
<script th:inline="javascript">
	/*<![CDATA[*/
	glyph_opts = {
		map: {
			doc: "fa fa-angle-right",
			docOpen: "glyphicon glyphicon-file",
			checkbox: "fa fa-minus-square",
			checkboxSelected: "fa fa-check",
			checkboxUnknown: "fa fa-minus-square",
			dragHelper: "glyphicon glyphicon-play",
			dropMarker: "glyphicon glyphicon-arrow-right",
			error: "glyphicon glyphicon-warning-sign",
			expanderClosed: "glyphicon glyphicon-menu-right",
			expanderLazy: "fa fa-angle-right", 
			expanderOpen: "fa fa-angle-down",
			folder: "fa fa-angle-right",
			folderOpen: "fa fa-angle-down",
			loading: "glyphicon glyphicon-refresh glyphicon-spin"
		}
	};
	
	function buildAccessListTrees(accessNodes, rootNode, tree){
		for (var i = 0; i < accessNodes.length; i++) {
		    var counter = accessNodes[i];			    
		    if(counter.parentPK == "0"){
		    	rootNode.addChildren({
		    		title: counter.name,
		    		tooltip: counter.name,
		    		isFolder: true,
		    		selected: counter.checked,
		    		key: counter.childPK
		    	});
		    }else{
		    	var parentNode = tree.getNodeByKey(counter.parentPK+"");
		    	parentNode.addChildren({
		    		title: counter.name,
		    		tooltip: counter.name,
		    		isFolder: false,
		    		selected: counter.checked,
		    		key: counter.childPK
		    	});
		    	parentNode.folder = true;
		    }
		}
	}
	
	$(function(){
	
		var save = function() {
			var tree = $("#accessibility-tree").fancytree("getTree");
			var selectedNodes = tree.getSelectedNodes();
		    var selectedKeys = $.map(selectedNodes, function(node){
		        return node.key;
		    });
		    $("#accessibility-tree").fancytree("getTree").visit(function(node){
			    if(node.partsel && node.hasChildren()) {
			    	if(!selectedNodes.inArray(node)){
						selectedKeys += "," + node.key;	
					}
			    }
			});
		    $("#accessibilities").val(selectedKeys);
		    $.post([[@{/do/accessibility/save?skipdecorator}]], $("#accessibilityForm").serialize(), function(data){
		    	bootBoxSuccessSave("Accessibility Successfully Saved", function(){
		    		$("#appRole-accessibilityModal").modal("hide");	
		    	});
			});
		}
		
		var treeURL = /*[[@{/do/appRole/loadAccessibilityTree}]]*/ #;
    	$("#accessibility-tree").fancytree({
			extensions: ["dnd", "edit", "glyph", "wide"],
			checkbox: true,
			dnd: {
				focusOnClick: true,
				dragStart: function(node, data) { return true; },
				dragEnter: function(node, data) { return false; },
				dragDrop: function(node, data) { data.otherNode.copyTo(node, data.hitMode); }
			},
			glyph: glyph_opts,
			selectMode: 3,
			toggleEffect: { effect: "drop", options: {direction: "left"}, duration: 400 },
			wide: {
				iconWidth: "1em",
				iconSpacing: "0.5em",
				levelOfs: "1.5em"
			}
		});
    	
    	var rootNode = $("#accessibility-tree").fancytree("getRootNode");
		var tree = $("#accessibility-tree").fancytree("getTree");
		var accessNodes = /*[[${accessNodes}]]*/ #;
		buildAccessListTrees(accessNodes, rootNode, tree);
		
		$("#appRoleAccessibility-btn-save").click(function(e){
			e.preventDefault();
			save();
		});
	})
	/*]]>*/
</script>