<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:ifs="http://padiku.id">
<head>
<meta charset="ISO-8859-1"/>
<title>Purchase Order</title>
</head>
<body>
	<div class="pageheader">
		<h4><i class="fa fa-shopping-basket"></i> Pembelian / Tambah Pembelian
		<span></span></h4>
	</div>
	<div class="row col-md-10">
	<section class="tile transparent">
			<div class="tile-body rounded-corners">
				<div class="tile-body rounded-corners">
					<form action="#" id="purchaseOrder-detail-form" class="form-horizontal" method="POST" novalidate="novalidate" th:object="${detail}">
						<div class="stockTypeStyle">
							<h3>
								<strong>Informasi</strong> Utama
							</h3>
							<div class="form-group">
								<div class="col-md-11" style='margin: 10px;'>
									<div id="errorFragmentList">
										<th:block th:if="${message}">
											<div class='alert alert-success'>
												<a href='#' class='close' data-dismiss='alert'
													aria-label='close' title='close'>&#10006;</a> <label
													th:text="${message}"></label>
											</div>
										</th:block>
									</div>
								</div>
								&nbsp;
							</div>
							<input id="purchaseOrder-detail-maintenancePk" type="hidden" th:field="*{pkPurchaseOrder}" />
							<input id="purchaseOrder-detail-company-pkCompany" type="hidden" th:field="*{company.pkCompany}" /> 
							<input id="purchaseOrder-detail-status" type="hidden" th:field="*{status}" />
							<div class="form-group">
								<label class="col-sm-4 control-label" th:text="'No.PO'">No.PO</label>
								<div class="col-sm-8 form-input-container">
									<input th:if="*{poNumber == null}" type="text" id="purchaseOrder-detail-input-text-poNumber" class="form-control" placeholder="Generated By System" name="srch-term" readonly="readonly"/>
									<input th:if="*{poNumber != null}" type="text" id="purchaseOrder-detail-input-text-poNumber" class="form-control" name="srch-term" th:value="*{poNumber}" readonly="readonly"/>
								</div>
							</div>
							<div class="form-group">
								<label class="col-sm-4 control-label" th:text="'Nama Supplier'">Nama Supplier</label>
								<div class="col-sm-8 form-input-container">
									<select id='purchaseOrder-detail-select-supplier' class="chosen-select chosen-transparent form-control" th:field="*{supplier.pkParty}">
										<option th:each="opt : ${optionSupplier}" th:value="${opt.pkParty}" th:text="${opt.name}"></option>
									</select>
								</div>
							</div>
							<div class="form-group">
								<label class="col-sm-4 control-label"
									th:text="'Jenis Pembayaran'">Jenis Pembayaran</label>
								<div class="col-sm-8 form-input-container">
									<select id='purchaseOrder-detail-select-termOfPayment' class="chosen-select chosen-transparent form-control" th:field="*{termOfPayment.pkCompanyLookup}">
										<option th:each="opt : ${optionTermOfPayment}" th:value="${opt.pkCompanyLookup}" th:text="${opt.name}"></option>
									</select>
								</div>
							</div>
							<div class="form-group">
								<label class="col-sm-4 control-label" th:text="'Mata Uang'">Mata Uang</label>
								<div class="col-sm-8 form-input-container">
									<select id='purchaseOrder-detail-select-currency' class="chosen-select chosen-transparent form-control" th:field="*{currency.pkCompanyLookup}">
										<option th:each="opt : ${optionCurrency}" th:value="${opt.pkCompanyLookup}" th:text="${opt.name}"></option>
									</select>
								</div>
							</div>
							<div class="form-group">
								<label class="col-sm-4 control-label" th:text="'Jumlah'">Jumlah</label>
								<div class="col-sm-8 form-input-container">
									<input type="text" id="purchaseOrder-detail-input-text-quantity" class="form-control" placeholder="Jumlah" name="srch-term" th:field="*{quantity}" readonly="readonly"/>
								</div>
							</div>
							<div class="form-group">
								<label class="col-sm-4 control-label" th:text="'Sub.Total'">Sub.Total</label>
								<div class="col-sm-8 form-input-container">
									<div class="input-group">
										<span class="input-group-addon addon-greensea">Rp</span>
										<input type='text' id='purchaseOrder-detail-input-text-subvalue' class="form-control autonumeric" th:field="*{subvalue}" readonly="readonly"/>
									</div>
								</div>
							</div>
							<div class="form-group">
								<label class="col-sm-4 control-label" th:text="'Pajak'">Pajak</label>
								<div class="col-sm-8 form-input-container">
									<div class="input-group">
										<span class="input-group-addon addon-greensea">&#37;</span>
										<input type='text' id='purchaseOrder-detail-input-text-vatPercent' class="form-control autonumeric" th:field="*{vatPercent}" />
									</div>
								</div>
							</div>
							<div class="form-group">
								<label class="col-sm-4 control-label" th:text="'Nilai Pajak'">Nilai Pajak</label>
								<div class="col-sm-8 form-input-container">
									<div class="input-group">
										<span class="input-group-addon addon-greensea">Rp</span>
										<input type='text' id='purchaseOrder-detail-input-text-vatValue' class="form-control autonumeric" th:field="*{vatValue}" readonly="readonly"/>
									</div>
								</div>
							</div>
							<div class="form-group">
								<label class="col-sm-4 control-label" th:text="'Total Harga'">Total Harga</label>
								<div class="col-sm-8 form-input-container">
									<div class="input-group">
										<span class="input-group-addon addon-greensea">Rp</span>
										<input type='text' id='purchaseOrder-detail-input-text-totalValue' class="form-control autonumeric" th:field="*{totalValue}" readonly="readonly"/>
									</div>
								</div>
							</div>
							<div class="form-group">
								<label class="col-sm-4 control-label" th:text="'Tanggal'">Tanggal</label>
								<div class="col-sm-8 form-input-container">
									<div class='input-group date'>
										<input type='text' id='purchaseOrder-detail-input-date-purchaseOrderDate' class="datepicker input-date form-control" th:field="*{purchaseOrderDate}" />
										<span class="input-group-addon addon-greensea">
											<i class="fa fa-calendar"></i>
										</span>
									</div>
								</div>
							</div>
							<div class="form-group">
								<label class="col-sm-4 control-label" th:text="'Reference ID'">Reference ID</label>
								<div class="col-sm-8 form-input-container">
									<input type="text" id="purchaseOrder-detail-input-text-referenceId" class="form-control" placeholder="Reference ID" name="srch-term" th:field="*{poNumber}" />
								</div>
							</div>
							<h3>
								<strong>Produk</strong> Detail
							</h3>
							<div class="form-group">
								<label class="col-sm-2 control-label" for="input01"></label>
								<div class="col-sm-10">
									<div class="input-group input-group-sm">
										<!-- tile -->
										<section class="tile color transparent">
											<!-- /tile widget -->
											<!-- tile body -->
											<div class="tile-body color greensea rounded-corners">
												<a href="#" id="purchaseOrder-detail-produk-btn-tambah" class="btn btn-default" type="reset" data-toggle="tooltip" title="" data-original-title="Tambahkan Produk">Tambah</a>
												<table id="purchaseOrder-produk-table" class="table table-custom table-sortable">
													<thead>
														<tr>
															<th>Nama Produk</th>
															<th width="15%">Satuan</th>
															<th>Jumlah</th>
															<th>Harga Beli</th>
															<th>Total Pembelian</th>
															<th style="width: 30px;"></th>
														</tr>
													</thead>
													<tbody id="purchaseOrder-produk-table-tbody">
														<th:block th:if="*{not #lists.isEmpty(purchaseOrderElements)}">
															<tr th:each="dtl : *{purchaseOrderElements}">
																<td>
																	<div class="input-group input-group-sm">
																		<input type="hidden" class="form-control purchaseOrder-product-table-product-pk" th:value="${dtl.product.pkCompanyProduct}"/>
																		<input type="hidden" class="form-control purchaseOrder-product-table-product-seqNo" th:value="${dtl.sequenceNumber}"/>
																		<input type="text" class="form-control purchaseOrder-product-table-product-name-class" th:value="${dtl.product.name}"/>
																	</div>
																</td>
																<td>
																	<div class="input-group input-group-sm">
																		<select class="form-control purchaseOrder-product-table-product-uom">
																			<option th:each="opt : ${optionUOM}" th:value="${opt.pkLookup}" th:text="${opt.name}" th:selected="${opt.pkLookup == dtl.uom.pkLookup}"></option>
																		</select>
																	</div>
																</td>
																<td>
																	<div class="input-group input-group-sm">
																		<input type="text" class="form-control purchaseOrder-product-table-quantity" th:value="${dtl.quantity}"/>
																	</div>
																</td>
																<td>
																	<div class="input-group input-group-sm">
																		<span class="input-group-addon addon-greensea">Rp</span>
																		<input type="text" class="form-control purchaseOrder-product-table-product-buying-price" th:value="${dtl.purchasePrice}"/>
																	</div>
																</td>
																<td>
																	<div class="input-group input-group-sm">
																		<span class="input-group-addon addon-greensea">Rp</span>
																		<input type="text" class="form-control purchaseOrder-product-table-totalValue" value="0" th:value="${dtl.orderValue}"/>
																	</div>
																</td>
																<td class="text-center">
																	<a href="#" class="btn btn-primary btn-xs margin-bottom-20 purchaseOrder-product-table-btn-delete" data-toggle="tooltip" title="" data-original-title="Delete">
																		<i class="fa fa-trash"></i>
																	</a>
																</td>
															</tr>
														</th:block>
														<th:block th:if="*{#lists.isEmpty(purchaseOrderElements)}">
															<tr>
																<td>
																	<div class="input-group input-group-sm">
																		<input type="hidden" class="form-control purchaseOrder-product-table-product-pk"/>
																		<input type="hidden" class="form-control purchaseOrder-product-table-product-seqNo"/>
																		<input type="text" class="form-control purchaseOrder-product-table-product-name-class"/>
																	</div>
																</td>
																<td>
																	<div class="input-group input-group-sm">
																		<select class="form-control purchaseOrder-product-table-product-uom">
																			<option th:each="opt : ${optionUOM}" th:value="${opt.pkLookup}" th:text="${opt.name}"></option>
																		</select>
																	</div>
																</td>
																<td>
																	<div class="input-group input-group-sm">
																		<input type="text" class="form-control purchaseOrder-product-table-quantity" value="0"/>
																	</div>
																</td>
																<td>
																	<div class="input-group input-group-sm">
																		<span class="input-group-addon addon-greensea">Rp</span>
																		<input type="text" class="form-control purchaseOrder-product-table-product-buying-price" value="0"/>
																	</div>
																</td>
																<td>
																	<div class="input-group input-group-sm">
																		<span class="input-group-addon addon-greensea">Rp</span>
																		<input type="text" class="form-control purchaseOrder-product-table-totalValue" value="0"/>
																	</div>
																</td>
																<td class="text-center">
																	<a href="#" class="btn btn-primary btn-xs margin-bottom-20 purchaseOrder-product-table-btn-delete" data-toggle="tooltip" title="" data-original-title="Delete">
																		<i class="fa fa-trash"></i>
																	</a>
																</td>
															</tr>
														</th:block>
													</tbody>
													<tfoot>
														<tr>
															<th>Total</th>
															<th id="purchaseOrder-product-table-label-total" colspan="2" style="width: 10px;">0</th>
															<th colspan="2"></th>
															<th style="width: 30px;"></th>
														</tr>
													</tfoot>
												</table>
											</div>
											<!-- /tile body -->
										</section>
										<!-- /tile -->
									</div>
								</div>
							</div>
						</div>
						<div class="form-group form-footer">
							<label for="input07" class="col-sm-4 control-label">&nbsp;</label>				
							<div class="col-md-4 tile-body no-vpadding" style="margin:10px;">
								<button id="purchaseOrder-detail-btn-save" class="btn btn-primary" type="submit" data-toggle="tooltip" title="" data-original-title="Menyimpan data">Simpan</button>
								<a href="#" id="purchaseOrder-detail-btn-cancel" class="btn btn-default" type="reset" data-toggle="tooltip" title="" data-original-title="Kembali ke list setting produk">Batal</a>
							</div>
						</div>
					</form>
				</div>
			</div>
			<div id="hidden-select-container" style="display:none">
				<select class="form-control purchaseOrder-product-table-product-uom">
					<option th:each="opt : ${optionUOM}" th:value="${opt.pkLookup}" th:text="${opt.name}"></option>
				</select>
			</div>
	</section>
	</div>
	<script th:inline="javascript">
	/*<![CDATA[*/
		var insertNewRow = function() {
			var newRow = '<tr><td>' +
							'<div class="input-group input-group-sm">' + 
							'<input type="hidden" class="form-control purchaseOrder-product-table-product-pk"/>' +
							'<input type="hidden" class="form-control purchaseOrder-product-table-product-seqNo"/>' +
							'<input type="text" class="form-control purchaseOrder-product-table-product-name-class"/>' +
							'</div>' +
						 '</td>' +
						 '<td>' +
							'<div class="input-group input-group-sm">' +
							$('#hidden-select-container').html() +
							'</div>' +
						 '</td>' +
						 '<td>' +
							'<div class="input-group input-group-sm">' +
							'<input type="text" class="form-control purchaseOrder-product-table-quantity" value="0"/>' +
							'</div>' +
						 '</td>' +
						 '<td>' + 
							'<div class="input-group input-group-sm">' +
							'<span class="input-group-addon addon-greensea">Rp</span>' +
							'<input type="text" class="form-control purchaseOrder-product-table-product-buying-price" value="0"/>' +
							'</div>' + 
						 '</td>' +
						 '<td>' +
						 	'<div class="input-group input-group-sm">' +
						 	'<span class="input-group-addon addon-greensea">Rp</span>' +
						 	'<input type="text" class="form-control purchaseOrder-product-table-totalValue" value="0"/>' +
						 	'</div>' +
						 '</td>' +
						 '<td class="text-center">' +
						 	'<a href="#" class="btn btn-primary btn-xs margin-bottom-20 purchaseOrder-product-table-btn-delete" data-toggle="tooltip" title="" data-original-title="Delete">' +
						 	'<i class="fa fa-trash"></i>' +
						 	'</a>' +
						 '</td>' + 
						 '</tr>';
				$('#purchaseOrder-produk-table-tbody').append(newRow);
				initProductDelete();
				initAutoComplete();
				initTotalValuePerRowCalculation();
		};
		
		var deleteCurrentRow = function(obj){
			$(obj).closest('tr').remove();
			calculateTotalValue();
			calculateTotalQuantity();
		};
		
		function initProductDelete() {
			$('.purchaseOrder-product-table-btn-delete').click(function(e){
				e.preventDefault();
				deleteCurrentRow(e.target);
			});
		}
		
		function calculateTotalQuantity() {
			var totalQty = parseInt(0);
			$('.purchaseOrder-product-table-quantity').each(function(){
				var thisVal = parseInt($(this).val());
				if(thisVal > 0) {
					totalQty += thisVal;
				}
			});
			$('#purchaseOrder-detail-input-text-quantity').val(totalQty);
		}
		
		function calculateTotalValue() {
			var totalVal = parseInt(0);
			var totalValIncludeVat = parseInt(0);
			$('.purchaseOrder-product-table-totalValue').each(function(){
				var thisVal = parseInt($(this).val());
				if(thisVal > 0) {
					totalVal += thisVal;
				}
			});
			$('#purchaseOrder-product-table-label-total').html(totalVal);
			if(totalVal){
				var vat = parseFloat($('#purchaseOrder-detail-input-text-vatPercent').val());
				if(!vat) {
					vat = parseFloat(0);	
				}
				var vatValue = totalVal * vat / 100;
				var subValue = totalVal;
				totalVal += vatValue;
				$('#purchaseOrder-detail-input-text-subvalue').val(subValue);
				$('#purchaseOrder-detail-input-text-vatValue').val(vatValue);
				$('#purchaseOrder-detail-input-text-totalValue').val(totalVal);
			}else{
				$('#purchaseOrder-detail-input-text-subvalue').val(0);
				$('#purchaseOrder-detail-input-text-vatValue').val(0);
				$('#purchaseOrder-detail-input-text-totalValue').val(0);
			}
		}
		
		function initTotalValuePerRowCalculation() {
			$('.purchaseOrder-product-table-quantity').change(function(e){
				calculateTotalValuePerRow(e.target);
				calculateTotalValue();
				calculateTotalQuantity();
			});
		}
		
		function calculateTotalValuePerRow(obj) {
			var value = parseInt($(obj).val());
			if(value && value > 0) {
				var buyingPrice = parseInt($(obj).closest('tr').find('.purchaseOrder-product-table-product-buying-price').val());
				var totalValue = value * buyingPrice;
				$(obj).closest('tr').find('.purchaseOrder-product-table-totalValue').val(totalValue);
			} else {
				$(obj).val(0);
				$(obj).closest('tr').find('.purchaseOrder-product-table-totalValue').val(0);
			}
		}
		
		function initAutoCompleteProductCode() {
			var sURLProductAutocomplete = /*[[@{/do/masterData/product/searchProduct}]]*/ #;
	    	var productObj = new Bloodhound({
	    	    datumTokenizer: function (datum) {
	    	        return Bloodhound.tokenizers.whitespace(datum.value);
	    	    },
	    	    queryTokenizer: Bloodhound.tokenizers.whitespace,
	    	    remote: {
	    	    	url: sURLProductAutocomplete+'?keyword=%QUERY',
	    	    	wildcard: '%QUERY',
	    	        filter: function (products) {
	    	            return $.map(products, function (product) {
	    	                return {
	    	                    value: product.name,
	    	                    pk : product.pkCompanyProduct,
	    	                    buyingPrice : product.buyingPrice,
	    	                    uom : product.uom.pkLookup
	    	                };
	    	            });
	    	        }
	    	    }
	    	});
	    	return productObj;
		}
		
		function initAutoComplete() {			
			var productAutoCompleteObj = initAutoCompleteProductCode();
	    	$('.purchaseOrder-product-table-product-name-class').not('.tt-input,.tt-hint').typeahead({
	    	    highlight: true,
	    	}, {
	    	    displayKey: 'value',
	    	    source: productAutoCompleteObj.ttAdapter()
	    	}).on('typeahead:selected', function (e, datum) {
	    		var obj = e.target;
	    	    $(obj).closest('tr').find('.purchaseOrder-product-table-product-pk').val(datum.pk);
	    	    $(obj).closest('tr').find('.purchaseOrder-product-table-product-name-class').val(datum.value);
	    	    $(obj).closest('tr').find('.purchaseOrder-product-table-product-uom').val(datum.uom);
	    	    $(obj).closest('tr').find('.purchaseOrder-product-table-product-buying-price').val(datum.buyingPrice);
	    	});
		}
			
	    $(function(){
	    	$('.datepicker').datepicker({
	    	    autoclose: true,
	    	    todayHighlight: true,
	    		format: 'dd/mm/yyyy',
	    		onSelect: function(dateText, datePicker) {
	    			$(this).attr('value', dateText);
    		    }
            }).datepicker("setDate", new Date());
	    	initProductDelete();
	    	initAutoComplete();
	    	initTotalValuePerRowCalculation();
	    	
			var backToList = function(){
				returnToList('purchaseOrder-detail-container', 'purchaseOrder-list-container', true);
			};
			
			var serializeProductTable = function() {
				var index = 0;
				$('#purchaseOrder-produk-table-tbody tr').each(function(){
					$(this).find('.purchaseOrder-product-table-product-pk').attr('name', 'purchaseOrderElements['+index+'].product.pkCompanyProduct');
					$(this).find('.purchaseOrder-product-table-product-uom').attr('name', 'purchaseOrderElements['+index+'].uom.pkLookup');
					$(this).find('.purchaseOrder-product-table-product-seqNo').val(parseInt(index)+1);
					$(this).find('.purchaseOrder-product-table-product-seqNo').attr('name', 'purchaseOrderElements['+index+'].sequenceNumber');
					$(this).find('.purchaseOrder-product-table-quantity').attr('name', 'purchaseOrderElements['+index+'].quantity');
					$(this).find('.purchaseOrder-product-table-product-buying-price').attr('name', 'purchaseOrderElements['+index+'].purchasePrice');
					$(this).find('.purchaseOrder-product-table-totalValue').attr('name', 'purchaseOrderElements['+index+'].orderValue');
					index++;
				});
			};
	    	
			var submitForm = function(){
				cleanErrorParsley();
				serializeProductTable();
				var sURL = /*[[@{/do/purchaseOrder/savePurchaseOrder/}]]*/ #;
				$.post(sURL, $("#purchaseOrder-detail-form").serialize(), function(data) {
					if(data.errorList!=null){
						console.log(data.errorList);
						displayErrorParsley(data.errorList);
					}else{
						backToList();
					}
				});
			};
			
			$('#purchaseOrder-detail-btn-save').click(function(e){
				e.preventDefault();
				submitForm();
			});
			
			$('#purchaseOrder-detail-btn-cancel').click(function(e){
				e.preventDefault();
				backToList();
			});
			
			$('#purchaseOrder-detail-produk-btn-tambah').click(function(e){
				e.preventDefault();
				insertNewRow();
			});
			
			$('#purchaseOrder-detail-input-text-vatPercent').change(function(e){
				calculateTotalValue();
			});
	    });
	/*]]>*/
	</script>
</body>
</html>