<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:ifs="http://btn.co.id">
<head>
<meta charset="ISO-8859-1"/>
<title>TransOut</title>
</head>
<body>
<div id="padiku-wizard">
	<div class="pageheader">
		<div class="row col-md-8">
			<h4><i class="fa fa-tachometer"></i> Penjualan / Tambah Penjualan<span></span></h4>
		</div>
		<!-- Wizard Section -->
		<div id="fuelux-wizard" class="row-fluid col-md-8" data-target="#step-container">
	    	<ul class="wizard-steps">
	        	<li data-target="step1" class="active">
					<span class="step">1</span>
					<span class="title">Informasi Penjualan</span>
	            </li>
	            <li data-target="step2">
	             	<span class="step">2</span>
	             	<span class="title">Detail Penjualan</span>
	            </li>
	            <li data-target="step3">
	             	<span class="step">3</span>
	                <span class="title">Biaya-biaya</span>
				</li>
			</ul>
		</div>
	</div>
	<div class="row col-md-8">
		<section class="tile transparent">
			<div class="tile-body rounded-corners">
				<form action="#" id="transOut-detail-form" class="form-horizontal" method="POST" novalidate="novalidate" th:object="${detail}">
						<div class="stockTypeStyle">
							<div class="form-group">
								<div class="col-md-11" style='margin:10px;'>
									<div id="errorFragmentList">
										<th:block th:if="${message}">
											<div class='alert alert-success'>
												<a href='#' class='close' data-dismiss='alert' aria-label='close' title='close'>&#10006;</a>			
												<label th:text="${message}"></label>
											</div>
										</th:block>
									</div>
								</div>									
							&nbsp;
							</div>
							<input id="transOut-detail-maintenancePk" type="hidden" th:field="*{pkTransOut}"/>
							<input id="transOut-detail-valid" type="hidden" th:field="*{status}"/>
							<input id="transOut-detail-companyPK" type="hidden" th:field="*{company.pkCompany}"/>
							
							<!-- STEP #1 -->
							<div class="active tab-pane" id="step1">
	                           	<div class="form-group">
	                              	<label class="col-sm-3 control-label" th:text="'ID.Penjualan'">ID.Penjualan</label>
	                              	<div class="col-sm-9">
	                                	<label th:if="*{outNo == null}" th:text="'Generated By System'"></label>
	                              		<label th:if="*{outNo != null}">
	                              			<input type="text" class="form-control" th:field="*{outNo}" readonly="readonly"/>
	                              		</label>
	                              	</div>
	                           	</div>
	                           	<div class="form-group">
									<label class="col-sm-3 control-label">Nama Pembeli</label>
	                              		<div class="col-sm-9 form-input-container">
	                                 		<select class="chosen-select form-control" th:field="*{thirdParty.pkParty}">
	                                 			<option th:each="opt : ${optionsCustomer}" th:value="${opt.pkParty}" th:text="${opt.name}"></option>
	                                 		</select>
	                              		</div>
	                           	</div>
	                           	<div class="form-group">
									<label class="col-sm-3 control-label">Pengangkut</label>
	                              		<div class="col-sm-9 form-input-container">
	                                 		<select class="chosen-select form-control" th:field="*{transporter.pkParty}">
	                                 			<option th:each="opt : ${optionsTransporter}" th:value="${opt.pkParty}" th:text="${opt.name}"></option>
	                                 		</select>
	                              		</div>
	                           	</div>
	                           	<div class="form-group transOut-show-when-buy-only">
	                            	<label for="input07" class="col-sm-3 control-label">Jenis Pembayaran</label>
	                              	<div class="col-sm-9">
	                                	<select class="chosen-select chosen-transparent form-control" th:field="*{termOfPayment.pkCompanyLookup}">
	                                    	<option th:each="opt : ${optionsTermOfPayment}" th:value="${opt.pkCompanyLookup}" th:text="${opt.nameId}"></option>
	                                 	</select>
	                              	</div>
	                           	</div>
	                           	<div class="form-group">
	                              	<label class="col-sm-3 control-label">Tanggal Penjualan</label>
	                              	<div class="col-sm-9">
	                                	<input type='text' class="datepicker input-date form-control" th:field="*{outDate}" />
	                              	</div>
	                           	</div>
	                     	</div>
	                     	<!-- END STEP #1 -->
                     	
                     	<!-- STEP #2 -->
						<div class="tab-pane" id="step2">
                           	<div class="form-group product-section-non-list">
                            	<label class="col-sm-3 control-label">Nama Barang</label>
                              	<div class="col-sm-9">
                              		<input type="hidden" class="transOut-hidden-transInItem-maintenancePK"/>
									<select class="transOut-select-companyProduct preSerialize-remove chosen-select chosen-transparent form-control">
										<option value="">[Silahkan Pilih Product]</option>
										<option th:each="item : ${optionsCompanyProductStock}" th:value="${item.pkCompanyProduct}" th:attr="type=${item.type?.code}" th:text="${item.name}" th:selected="${detail.stockCompanyProduct?.pkCompanyProduct == item.pkCompanyProduct}"></option>
									</select>
                              	</div>
                           	</div>
                          	<div class="form-group">
									<label class="col-sm-3 control-label">Stock yang dijual </label>
	                             	<div class="col-sm-9 form-input-container"></div>
	                           	</div>
                           	
                           	<!-- Product List Section -->
                           	<div class="form-group product-section-list">
	                        	<div class="col-sm-12">
									<div class="input-group input-group-sm" style="width:100%;">
									<!-- tile -->
	                					<section class="tile color transparent-white">
	                  					<!-- tile body -->
	                  						<div class="tile-body transparent rounded-corners">
	                   							<table class="table table-custom table-sortable transOut-table-product" style="width:100%;">
					 								<thead>
								                        <tr>
								                          <th style="width:3%">No.</th>
								                          <th style="width:15%">Volume Stock</th>
								                          <th style="width:14%">Nilai Stock Persatuan/Kg</th>
								                          <th style="width:14%">Volume yang dibeli</th>
								                          <th style="width:14%">Sub-Total</th>
								                        </tr>
								                    </thead>
	                     							<tbody>
	                     								<th:block th:if="*{#lists.isEmpty(items)}">
								                        <tr>
								                        	<td>1</td>
															<td>
																<div class="input-group input-group-sm" style="width:100%;">
																	<input type="text" class="form-control transOut-table-last-stockVolume preSerialize-remove" readonly='readonly'/>
																	<span class="input-group-addon addon-greensea">Kg</span>
																</div>
															</td>
															<td>
																<div class="input-group input-group-sm">
																	<span class="input-group-addon addon-greensea">Rp</span>
																	<input type="text" class="form-control transOut-table-hpp preSerialize-remove" value="0" readonly='readonly'/>
																</div>
															</td>
															<td>
																<div class="input-group input-group-sm" style="width:100%;">
																	<input type="text" class="form-control transOut-table-buyVolume preSerialize-remove"/>
																	<span class="input-group-addon addon-greensea">Kg</span>
																</div>
															</td>
															<td>
																<div class="input-group input-group-sm">
																	<span class="input-group-addon addon-greensea">Rp</span>
																	<input type="text" class="form-control transOut-table-subTotal preSerialize-remove" value="0" readonly='readonly'/>
																</div>
															</td>
								                        </tr>
								                        </th:block>
								                        <th:block th:if="*{not #lists.isEmpty(items)}">
								                        	<tr th:each="item, status : *{items}">
								                        	<td>
								                        		<div class="input-group input-group-sm" style="width:100%;">							  
																	<label class='transOut-table-seqNo' th:value="${status.index}">1</label>
																</div>
															</td>
								                        	<td>
								                        		<div class="input-group input-group-sm" style="width:100%;">
								                        			<input type="hidden" class="form-control transOut-table-pkTransOutItem preSerialize-remove" th:value="${item.pkTransOutItem}"/>			  
																	<input type="hidden" class="form-control transOut-table-last-pkStock preSerialize-remove" th:value="${item.stock.pkStock}"/>
																	<input type="text" class="form-control transOut-table-last-transaction preSerialize-remove" th:value="${item.stock.lastTransactionDescr}" readonly='readonly'/>
																</div>
															</td>
															<td>
																<div class="input-group input-group-sm" style="width:100%;">
																	<input type="text" class="form-control transOut-table-last-lastDateTransaction preSerialize-remove" readonly='readonly' th:value="${item.lastDateTransaction}"/>
																</div>
															</td>
															<td>
																<div class="input-group input-group-sm" style="width:100%;">
																	<input type="text" class="form-control transOut-table-last-thirdPartyName preSerialize-remove" readonly='readonly' th:value="${item.thirdPartyName}"/>
																</div>
															</td>
															<td>
																<div class="input-group input-group-sm" style="width:100%;">
																	<input type="text" class="form-control transOut-table-last-stockVolume preSerialize-remove" readonly='readonly' th:value="${item.stock.volumeInKg}"/>
																</div>
															</td>
															<td>
																<div class="input-group input-group-sm">
																	<span class="input-group-addon addon-greensea">Rp</span>
																	<input type="text" class="form-control transOut-table-hpp preSerialize-remove" value="0" readonly='readonly' th:value="${item.fee}"/>
																</div>
															</td>
															<td>
																<div class="input-group input-group-sm" style="width:100%;">
																	<input type="text" class="form-control transOut-table-buyVolume preSerialize-remove" th:value="${item.volume}"/>
																</div>
															</td>
															<td>
																<div class="input-group input-group-sm">
																	<span class="input-group-addon addon-greensea">Rp</span>
																	<input type="text" class="form-control transOut-table-subTotal preSerialize-remove" th:value="${item.totalOutFee}" readonly='readonly'/>
																</div>
															</td>
								                        </tr>
								                        </th:block>
								                    </tbody>
				  								  	<tfoot>
								                        <tr>
								                          <th colspan="3">Total</th>
								                          <th><div class="input-group input-group-sm" style="width:100%;">
																	<input type="text" class="form-control transOut-table-total-buyVolume preSerialize-remove" readonly='readonly'/>
																	<span class="input-group-addon addon-greensea">Kg</span>
																</div>
														  </th>
														  <th>
														  	<div class="input-group input-group-sm">
																	<span class="input-group-addon addon-greensea">Rp</span>
																	<input type="text" class="form-control transOut-table-total-subTotal preSerialize-remove" readonly='readonly'/>
																</div>
														  </th>
								                        </tr>
							                      	</tfoot>
	                   							</table>
					                 		</div>
						                  <!-- /tile body -->
						              </section>
					                <!-- /tile --> 
									</div>
	                       		</div>
	                      	</div>
                           	<!-- End Product List Section -->
                           	<div class="form-group">
								<label class="col-sm-3 control-label">Persentase Margin </label>
                             	<div class="col-sm-9 form-input-container">
									<div class="input-group">
				                		<input type="text" class="form-control margin-percentage" th:field="*{marginPercentage}"/>
				                		<span class="input-group-addon addon-greensea">%</span>
				             		</div>
                             	</div>
                           	</div>
                           	<div class="form-group">
								<label class="col-sm-3 control-label">Harga Rujukan </label>
                             	<div class="col-sm-9 form-input-container">
									<div class="input-group">
										<span class="input-group-addon addon-greensea">Rp</span>
				                		<input type="text" class="form-control advice-main-fee" readonly="readonly" th:field="*{adviceMainFee}"/>
				             		</div>
                             	</div>
                           	</div>
                           	<div class="form-group">
								<label class="col-sm-3 control-label">Harga Jual </label>
                             	<div class="col-sm-9 form-input-container">
									<div class="input-group">
										<span class="input-group-addon addon-greensea">Rp</span>
				                		<input type="text" class="form-control" th:field="*{mainFee}"/>
				             		</div>
                             	</div>
                           	</div>
                     	</div>
                     	<!-- END STEP #2 -->
                     	
                     	<!-- STEP #3 -->
                     	<div class="tab-pane" id="step3">
                     		<div class="form-group">
	                     		<div class="col-sm-12">
								<a href="#" class="btn btn-primary table-fee-add" data-toggle="tooltip" title="Tambah"><i class="fa fa-plus dropdown-plus"></i> Tambah</a>
								<section class="tile color transparent-white">
									<div class="tile-body transparent rounded-corners">
		                           		<table id="table-fee" class="table table-custom table-sortable">
			                            	<thead>
												<tr>
			                                    	<th style="width:50%">Item Biaya</th>
			                                    	<th>Harga</th>
			                                    	<th style="width: 30px;"></th>
			                                 	</tr>
			                              	</thead>
			                              	<tbody>
			                              		<th:block th:if="*{#lists.isEmpty(fees)}" >
				                                	<tr>
				                                    	<td>
				                                       		<div class="input-group" style="width:100%">
				                                          		<input type='text' class='form-control fee-descr'/>
				                                       		</div>
				                                    	</td>
				                                    	<td>
				                                       		<div class="input-group">
				                                          		<span class="input-group-addon addon-greensea">Rp</span>
				                                          		<input type="text" class="form-control fee numeric"/>
				                                       		</div>
				                                    	</td>
				                                    	<td class="text-center">
				                                    		<a href="#" class="btn btn-primary btn-xs margin-bottom-20 fee-delete-row" data-toggle="tooltip" title="Delete"><i class="fa fa-trash"></i></a>
				                                    	</td>
				                                 	</tr>
				                                 </th:block>
				                                 <th:block th:if="*{not #lists.isEmpty(fees)}" >
			                              			<tr th:each="item : *{fees}">
			                              				<td>
				                                       		<div class="input-group" style="width:100%">
				                                       			<input type='hidden' class="pk-fee" th:value="${item.pkTransProdFee}"/>
				                                          		<input type='text' class='form-control fee-descr' th:value="${item.descr}"/>
				                                       		</div>
				                                    	</td>
				                                    	<td>
				                                       		<div class="input-group">
				                                          		<span class="input-group-addon addon-greensea">Rp</span>
				                                          		<input type="text" class="form-control fee numeric" th:value="${item.fee}"/>
				                                       		</div>
				                                    	</td>
				                                    	<td class="text-center">
				                                    		<a href="#" class="btn btn-primary btn-xs margin-bottom-20 fee-delete-row" data-toggle="tooltip" title="Delete"><i class="fa fa-trash"></i></a>
				                                    	</td>
			                              			</tr>
			                              		 </th:block>
			                              	</tbody>
			                              	<tfoot>
			                                	<tr>
				                                    <th>Total biaya yg dikeluarkan</th>
			            	                    	<th>
			            	                    		<div class="input-group">
			                                          		<span class="input-group-addon addon-greensea">Rp</span>
			                                          		<input type="text" id="total-fee" class="form-control numeric" readonly="readonly"/>
			                                       		</div>
			            	                    	</th>
			            	                    	<th></th>
			            	                    </tr>
			                              	</tfoot>
		                           		</table>
	                           		</div>
	                           	</section>
	                     		</div>
                     		</div>
                     		
                     		<div id="masterFeeHiddenRow" style="display:none;">
								<table>
									<tr>
						          		<td>
						             		<div class="input-group" style="width:100%;">
						                		<input type='text' class='form-control transOut-table-masterFee-descr'/>
						             		</div>
						          		</td>
						          		<td>
						             		<div class="input-group">
						                		<span class="input-group-addon addon-greensea">Rp</span>
						                		<input type="text" class="form-control transOut-table-masterFee-fee"/>
						             		</div>
						          		</td>
						          		<td class="text-center"><a href="#" class="btn btn-primary btn-xs margin-bottom-20 transOut-table-masterFee-delete-row" data-toggle="tooltip" title="Delete"><i class="fa fa-trash"></i></a></td>
						       		</tr>
								</table>
							</div>
                     	</div>
                     	<!-- END STEP #3 -->
                     	
                     	<div class="wizard-actions form-group form-footer" style="background-color : rgba(0, 0, 0, 0.3)">
		                	<div class="col-sm-offset-4 col-sm-8">
		                		<button type="button" id="transOut-detail-btn-cancel" class="btn btn-default">
									<i class="icon-arrow-left"></i>Cancel
								</button>
			                	<button type="button" id="transOut-detail-btn-back" class="btn btn-default">
									<i class="icon-arrow-left"></i>Kembali
								</button>
								<button type="button" id="transOut-detail-btn-next" class="btn btn-primary">
									Lanjut
									<i class="icon-arrow-right icon-on-right"></i>
								</button>
								<button type="button" id="transOut-detail-btn-save" class="btn btn-primary">
									Simpan
									<i class="icon-arrow-right icon-on-right"></i>
								</button>
							</div>
						</div>
					</div>
				</form>
			</div>
	</section>
	</div>
</div>

<div id="master-trans-out" style="display:none">
	<div id="master-table-fee">
   			<table>
   				<tbody>
	   				<tr>
		               	<td>
	                  		<div class="input-group" style="width:100%">
	                     		<input type='text' class='form-control fee-descr'/>
	                  		</div>
		               	</td>
		               	<td>
	                  		<div class="input-group">
	                     		<span class="input-group-addon addon-greensea">Rp</span>
	                     		<input type="text" class="form-control fee numeric"/>
	                  		</div>
		               	</td>
		               	<td class="text-center">
		               		<a href="#" class="btn btn-primary btn-xs margin-bottom-20 fee-delete-row" data-toggle="tooltip" title="Delete"><i class="fa fa-trash"></i></a>
		               	</td>
	            	</tr>
				</tbody>
   			</table>
   		</div>
</div>
	<script th:inline="javascript">
	/*<![CDATA[*/

		function deleteThisRow (obj) {
			$(obj).closest('tr').remove();
		}
	
		$(function(){
	    	var initWizard = function(id,idbtncancel,idbtnprev,idbtnnext,idbtnfinish){
	    		$('.tab-pane').hide();
	    		var liLength = $('#'+id+' ul.wizard-steps li').length;
	    		
	    		$('#'+id+' ul.wizard-steps li').each(function(){
	    			$(this).css('width',100/parseInt(liLength)+'%').click(function(){
	    				$(this).removeClass('complete').addClass('active').prevAll().switchClass('active','complete');
	    				$(this).nextAll().removeClass('active complete');
	    				$('.wizard-actions button#'+idbtncancel).hide();
	    				$('.wizard-actions button#'+idbtnprev).hide();
	    				$('.wizard-actions button#'+idbtnnext).hide();
	    				$('.wizard-actions button#'+idbtnfinish).hide();
	    				if($(this).is(':first-child')){
	    					$('.wizard-actions button#'+ idbtncancel).show();	
	    				}else{
	    					$('.wizard-actions button#'+ idbtnprev).show();	
	    				}
	    				if($(this).is(':last-child')){
	    					$('.wizard-actions button#'+ idbtnfinish).show();
	    				}else{
	    					$('.wizard-actions button#'+ idbtnnext).show();
	    				}
	    	  			$('.tab-pane').hide();
	    	  			$('#'+$(this).attr('data-target')).show();
	    	  		});
	    	  	});
	    		$('.wizard-actions button#'+idbtncancel).click(function(e){
	    			e.preventDefault();
	    			backToList();
	    		});
	    		$('.wizard-actions button#'+idbtnprev).click(function(e){
	    			e.preventDefault();
	    			$('#'+id+' ul.wizard-steps li.active:not(.complete)').prev().trigger('click');
	    		});
				$('.wizard-actions button#'+idbtnnext).click(function(e){
					e.preventDefault();
					$('#'+id+' ul.wizard-steps li.active:not(.complete)').next().trigger('click');    		
				});
				$('.wizard-actions button#'+idbtnfinish).click(function(e){
					e.preventDefault();
					submitForm();
				});
	    	  	$('#'+id+' ul.wizard-steps').children().eq(0).trigger('click');
	    	};
	    	
	    	initWizard('padiku-wizard','transOut-detail-btn-cancel','transOut-detail-btn-back',
	    			'transOut-detail-btn-next','transOut-detail-btn-save');
	    	
	    	$('.datepicker').datepicker({
	    	    autoclose: true,
	    	    todayHighlight: true,
	    		format: 'dd/mm/yyyy',
	    		onSelect: function(dateText, datePicker) {
	    			$(this).attr('value', dateText);
    		    }
            }).datepicker("setDate", new Date());
	    	
	    	var backToList = function(){
				returnToList('transOut-detail-container', 'transOut-list-container', true);
			};
			
			var preSerialize = function() {
				var idxFee = 0;
				$('#table-fee tbody tr').each(function(){
					$(this).find('.fee-descr').attr('name', 'fees['+idxFee+'].descr');
					$(this).find('.fee').attr('name', 'fees['+idxFee+'].fee');
					idxFee++;
				});
				
				//serialize product list
				$('.preSerialize-remove').removeAttr('name');
				var productIndex = 0;
				$('.transOut-table-product').find('tbody').find('tr').each(function(){						
					$(this).find('.transOut-table-pkTransOutItem').attr('name', 'items['+productIndex+'].pkTransOutItem');
					$(this).find('.transOut-table-last-pkStock').attr('name', 'items['+productIndex+'].stock.pkStock');
					$(this).find('.transOut-table-hpp').attr('name', 'items['+productIndex+'].fee');
					$(this).find('.transOut-table-buyVolume').attr('name', 'items['+productIndex+'].volume');
					$(this).find('.transOut-table-subTotal').attr('name', 'items['+productIndex+'].totalOutFee');					
					productIndex++;
				});
			}
	    	
			var submitForm = function(){
				cleanErrorParsley();
				var sURL = /*[[@{/do/penjualan/saveTransOut/}]]*/ #;
				preSerialize();
				$.post(sURL, $("#transOut-detail-form").serialize(), function(data) {
					if(data.errorList!=null){
						displayErrorParsley(data.errorList);
					}else{
						backToList();
					}
				});
			};
			
			var formatDate = function(millis) {
				if(millis){
					var time = new Date(millis);
					var year=time.getFullYear();
					var month=time.getMonth()+1;
					var date=time.getDate();
					return date+"/"+month+"/"+year;
				}else{					
					return "";
				}
			}
			
			var populateStockList = function () {
				var code = $('.transOut-radio-filter:checked').val();
				var pkCompanyProduct = $('.transOut-select-companyProduct').val();
				$('.transOut-table-product').find('tbody').html('');
				if(pkCompanyProduct) {
					var sURL = /*[[@{/do/penjualan/getStockListByCompanyProduct?}]]*/ #;
					sURL += "pkCompanyProduct=" + $('.transOut-select-companyProduct').val() + "&tiSourceType=BUY";
					$.get(sURL, function(data) {
						var html = "";
						if(data) {
							for(var i=0;i<data.length;i++) {
								html += "<tr>";
								html += "<td>";
								html += "<div class='input-group input-group-sm' style='width:100%;'>";							  
								html += "<label class='transOut-table-seqNo'>" + (i + 1) + "</label>";
								html += "</div>";
								html += "</td>";
								html += "<td>";
								html += "<div class='input-group input-group-sm' style='width:100%;'>";						  
								html += "<input type='hidden' class='form-control transOut-table-last-pkStock preSerialize-remove' value='"+data[i].pkStock+"'/>";
								html += "<input type='text' class='form-control transOut-table-last-transaction preSerialize-remove' value='"+data[i].remainingVolumeInKg+"' readonly='readonly'/>";
								html += "</div>";
								html += "</td>";
								html += "<td>";
								html += "<div class='input-group input-group-sm'>";
								html += "<span class='input-group-addon addon-greensea'>Rp</span>";
								html += "<input type='text' class='form-control transOut-table-hpp preSerialize-remove' value='"+data[i].hpp+"' readonly='readonly'/>";
								html += "</div>";
								html += "</td>";
								html += "<td>";
								html += "<div class='input-group input-group-sm' style='width:100%;'>";
								html += "<input type='text' class='form-control transOut-table-buyVolume preSerialize-remove' value='0'/>";
								html += "</div>";
								html += "</td>";
								html += "<td>";
								html += "<div class='input-group input-group-sm'>";
								html += "<span class='input-group-addon addon-greensea'>Rp</span>";
								html += "<input type='text' class='form-control transOut-table-subTotal preSerialize-remove' value='0' readonly='readonly'/>";
								html += "</div>";
								html += "</td>";
								html += "</tr>";
							}
							$('.transOut-table-product tbody').html(html);
							$('.transOut-table-buyVolume').change(function(e){
								calculateSummaryResult(e.target);
							});
						}
					});
				}
				calculateSummaryResult();
			}
			
			$('.transOut-radio-filter').change(function(e){
				populateStockList();
			});
			
			$('.transOut-table-masterFee-add').click(function(e){
				addRowMasterFee();
			});
			
			$('.transOut-select-companyProduct').change(function(){
				populateStockList();
			});
			
			var calculateSummaryResult = function (obj) {
				//calculate sub total
				if(obj){					
					var volume = parseInt($(obj).val());
					var hpp = parseInt($(obj).closest('tr').find('.transOut-table-hpp').val());
					if ( volume && hpp) {
						var subTotal = volume * hpp;
						$(obj).closest('tr').find('.transOut-table-subTotal').val(subTotal);
					} else {					
						$(obj).closest('tr').find('.transOut-table-subTotal').val(0);
					}
				}
				
				//calculate total
				var buyVolume = 0;
				$('.transOut-table-product .transOut-table-buyVolume').each(function(){
					if($(this).val()!=""){
						buyVolume += parseFloat($(this).val());
					}
				});
				$('.transOut-table-total-buyVolume').val(buyVolume);
				
				var subTotal = 0;
				$('.transOut-table-product .transOut-table-subTotal').each(function(){
					subTotal += parseFloat($(this).val());
				});
				$('.transOut-table-total-subTotal').val(subTotal);
			}
			
			$('.transOut-table-buyVolume').change(function(e){
				calculateSummaryResult(e.target);
			});
			
			var calcAdviceMainFee = function(){
				var marginPercentage = parseFloat($('.margin-percentage').val());
				var subTotal = parseFloat($('.transOut-table-total-subTotal').val());
				$('.advice-main-fee').val(subTotal - (parseFloat(marginPercentage/100)*subTotal));
			}
			$('.margin-percentage').change(function(){
				calcAdviceMainFee();
			});
			
			var calcTotalFee = function(){
	    		$('#table-fee tbody tr input.fee').change(function(){
	    			var totalFee = 0;
	    			$('#table-fee tbody tr input.fee').each(function(){
	    				if($(this).val()!=""){
	    					totalFee += parseFloat($(this).val());
	    				}
	    			});
	    			$('#table-fee #total-fee').val(totalFee);
	    		});
	    	};
	    	var calcTotalFee = function(){
	    		$('#table-fee tbody tr input.fee').change(function(){
	    			var totalFee = 0;
	    			$('#table-fee tbody tr input.fee').each(function(){
	    				if($(this).val()!=""){
	    					totalFee += parseFloat($(this).val());
	    				}
	    			});
	    			$('#table-fee #total-fee').val(totalFee);
	    		});
	    	};
	    	
	    	var deleteRowFee = function(){
	    		$('.fee-delete-row').click(function(){
	    			$(this).parent().parent().remove();
	    		});
	    	};
	    	
	    	$('.table-fee-add').click(function(){
	    		$('#table-fee tbody').append($('#master-trans-out #master-table-fee tbody').html());
	    		calcTotalFee();
	    		deleteRowFee();
	    	});
	    	
	    	calcTotalFee();
    		deleteRowFee();
			
	    	calculateSummaryResult();
	    });
	/*]]>*/
	</script>
</body>
</html>